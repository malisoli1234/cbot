<!-- Records Management Page -->
<div class="page-header">
    <h1>📋 مدیریت رکوردها</h1>
    <p>مشاهده و مدیریت تمام جستجوهای انجام شده</p>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">🔍 فیلترها</h2>
    </div>
    
    <form method="GET" action="/admin/records" class="d-flex justify-between">
        <div class="form-group">
            <label for="search-input" class="form-label">جستجو</label>
            <input type="text" id="search-input" name="search" class="form-control" 
                   placeholder="جستجو در ارز یا عبارت جستجو..." 
                   value="<%= filters.search || '' %>">
        </div>
        
        <div class="form-group">
            <label for="status-filter" class="form-label">وضعیت</label>
            <select id="status-filter" name="status" class="form-control">
                <option value="">همه</option>
                <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>در انتظار</option>
                <option value="processed" <%= filters.status === 'processed' ? 'selected' : '' %>>پردازش شده</option>
                <option value="edited" <%= filters.status === 'edited' ? 'selected' : '' %>>ویرایش شده</option>
                <option value="deleted" <%= filters.status === 'deleted' ? 'selected' : '' %>>حذف شده</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="pattern-filter" class="form-label">الگوی پیام</label>
            <select id="pattern-filter" name="pattern" class="form-control">
                <option value="">همه</option>
                <option value="PO" <%= filters.pattern === 'PO' ? 'selected' : '' %>>PO</option>
                <option value="QU" <%= filters.pattern === 'QU' ? 'selected' : '' %>>QU</option>
                <option value="OL" <%= filters.pattern === 'OL' ? 'selected' : '' %>>OL</option>
                <option value="ORG" <%= filters.pattern === 'ORG' ? 'selected' : '' %>>ORG</option>
                <option value="SIMPLE" <%= filters.pattern === 'SIMPLE' ? 'selected' : '' %>>SIMPLE</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                اعمال فیلتر
            </button>
        </div>
    </form>
</div>

<!-- Records Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">📊 رکوردها (<%= pagination.total %> مورد)</h2>
        <div>
            <button onclick="adminPanel.exportData()" class="btn btn-success">
                <i class="fas fa-download"></i>
                خروجی CSV
            </button>
        </div>
    </div>
    
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>ارز</th>
                    <th>جستجو</th>
                    <th>الگوی پیام</th>
                    <th>وضعیت</th>
                    <th>سایت‌ها</th>
                    <th>تاریخ</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
                <% records.forEach(record => { %>
                    <tr>
                        <td>
                            <strong><%= record.currencyName %></strong>
                            <% if (record.messageInfo && record.messageInfo.network) { %>
                                <br><small class="text-light"><%= record.messageInfo.network %></small>
                            <% } %>
                        </td>
                        <td><%= record.searchTerm %></td>
                        <td>
                            <% if (record.messageInfo && record.messageInfo.pattern) { %>
                                <span class="badge badge-info"><%= record.messageInfo.pattern %></span>
                            <% } else { %>
                                -
                            <% } %>
                        </td>
                        <td>
                            <span class="badge badge-<%= record.status === 'processed' ? 'success' : record.status === 'edited' ? 'info' : record.status === 'deleted' ? 'danger' : 'warning' %>">
                                <%= record.status %>
                            </span>
                        </td>
                        <td>
                            <% if (record.results && record.results.length > 0) { %>
                                <% const sites = [...new Set(record.results.map(r => r.site))]; %>
                                <% sites.forEach(site => { %>
                                    <span class="badge badge-info"><%= site %></span>
                                <% }); %>
                            <% } else { %>
                                -
                            <% } %>
                        </td>
                        <td><%= new Date(record.createdAt).toLocaleString('fa-IR') %></td>
                        <td>
                            <button class="btn btn-sm btn-danger btn-delete" data-id="<%= record._id %>">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <% if (pagination.totalPages > 1) { %>
        <div class="pagination">
            <% if (pagination.page > 1) { %>
                <a href="?page=<%= pagination.page - 1 %>&<%= new URLSearchParams(filters).toString() %>" class="pagination-item">
                    <i class="fas fa-chevron-right"></i>
                </a>
            <% } %>
            
            <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                <a href="?page=<%= i %>&<%= new URLSearchParams(filters).toString() %>" 
                   class="pagination-item <%= i === pagination.page ? 'active' : '' %>">
                    <%= i %>
                </a>
            <% } %>
            
            <% if (pagination.page < pagination.totalPages) { %>
                <a href="?page=<%= pagination.page + 1 %>&<%= new URLSearchParams(filters).toString() %>" class="pagination-item">
                    <i class="fas fa-chevron-left"></i>
                </a>
            <% } %>
        </div>
    <% } %>
</div> 